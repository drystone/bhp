#!/bin/sh

# Copyright 2010 John Hedges
#
# This file is part of bhp.
#
# bhp is free software: you can redistribute it and/or modify it under the
# terms of the GNU General Public License as published by the Free Software
# Foundation, either version 3 of the License, or (at your option) any later
# version.
#
# bhp is distributed in the hope that it will be useful, but WITHOUT ANY
# WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR
# A PARTICULAR PURPOSE. See the GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License along with
# bhp. If not, see <http://www.gnu.org/licenses/>.

TMPDIR=/tmp
TMP=$TMPDIR/.tmp
TEMPERATURES=$TMPDIR/temperatures.xml
STATE=$TMPDIR/state.xml
CSTATE=$TMPDIR/control-state.xml

for file in $TEMPERATURES $STATE $CSTATE; do
  if [ ! -e $file ]; then
    echo '<?xml version="1.0"?><empty/>' > $file
  fi
done

cd `dirname $0`
./bhpread >$TMP && mv $TMP $TEMPERATURES
xsltproc targets.xsl zones.xml >$TMPDIR/targets.xml
xsltproc state.xsl thermostats.xml >$TMP && mv $TMP $STATE
xsltproc control.xsl controls.xml >$TMP && mv $TMP $CSTATE
xsltproc actuate.xsl $CSTATE 2>/dev/null | /bin/sh

tanktemp=$(xmlstarlet sel -t -c "//*[@thermometer-id='tank_bottom']/text()" <$TEMPERATURES)
paneltemp=$(xmlstarlet sel -t -c "//*[@thermometer-id='solar']/text()" <$TEMPERATURES)
if [ $(echo "scale=3; $paneltemp > 90 || $paneltemp > $tanktemp + 15" | bc) -eq 1 ]; then
  ./bhpudin 5 on
  echo solar pump on
else
  ./bhpudin 5 off
fi

