#!/bin/sh

# Copyright 2010 John Hedges
#
# This file is part of bhp.
#
# bhp is free software: you can redistribute it and/or modify it under the
# terms of the GNU General Public License as published by the Free Software
# Foundation, either version 3 of the License, or (at your option) any later
# version.
#
# bhp is distributed in the hope that it will be useful, but WITHOUT ANY
# WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR
# A PARTICULAR PURPOSE. See the GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License along with
# bhp. If not, see <http://www.gnu.org/licenses/>.

TMPDIR=/tmp
TMP=$TMPDIR/.tmp
TEMPERATURES=$TMPDIR/temperatures.xml
STATE=$TMPDIR/state.xml
CSTATE=$TMPDIR/control-state.xml
LOG=bhplog
DATE=`date -R`

for file in $TEMPERATURES $STATE $CSTATE; do
  if [ ! -e $file ]; then
    echo '<?xml version="1.0"?><empty/>' > $file
  fi
done

cd `dirname $0`
./bhpread >$TMP && mv $TMP $TEMPERATURES
xsltproc targets.xsl zones.xml >$TMPDIR/targets.xml
xsltproc state.xsl thermostats.xml >$TMP && mv $TMP $STATE
xsltproc control.xsl controls.xml >$TMP && mv $TMP $CSTATE
commands=$(xsltproc actuate.xsl $CSTATE 2>/dev/null)
if [ -n "$commands" ]; then
    echo $commands | /bin/sh
    echo "$DATE: $commands" >>$LOG
fi
#xsltproc actuate.xsl $CSTATE | /bin/sh

udinons=`cat $CSTATE | xmlstarlet sel \
                -t -m "/control-states/control-state[@type='udin' and .='on']" \
                -v "concat(@device-code,' ')"`
teststate=`echo $udinons | python -c "import sys; print reduce(lambda x,y: int(x)+(1<<(int(y)-1)),('0 9 '+sys.stdin.readline()).strip().split(' ')) & 0xff"`
curstate=`./bhpudin -s`

if [ x$teststate != x$curstate ]; then
    echo "$DATE: udin - correct state=$teststate, actual state=$curstate" >>$LOG 
    echo Serious problem buddy: UDIN state should be $teststate but is $curstate 1>&2
    echo $commands
    ./bhpudin -r $teststate
fi

